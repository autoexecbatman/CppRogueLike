│ PDCurses to raylib Migration Plan                                                                                                                                                                             │
│                                                                                                                                                                                                               │
│ Context                                                                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ PDCurses was designed for terminal text rendering. We hacked DawnLike 16x16 sprite support into its SDL2 backend (pdc_tileset_active toggle, PDC_animate_tiles, pdc_tile_present[256]) but the result is      │
│ fragile: GUI corruption from clearok, door animation bugs, character conflicts, Emscripten ASYNCIFY issues. The user said "we exhausted curses" and chose a clean break to raylib. raylib provides native 2D  │
│ sprite rendering, built-in Emscripten support, and eliminates the dual-mode hack.                                                                                                                             │
│                                                                                                                                                                                                               │
│ Scope                                                                                                                                                                                                         │
│                                                                                                                                                                                                               │
│ Replace all PDCurses/curses usage across 32+ files with raylib. Convert blocking turn-based game loop to frame-based 60fps. Keep libtcod (FOV, pathfinding, BSP). Keep DawnLike tileset animation.            │
│                                                                                                                                                                                                               │
│ Dependencies                                                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ - Add: raylib (vcpkg)                                                                                                                                                                                         │
│ - Keep: libtcod, nlohmann-json, stb, gtest                                                                                                                                                                    │
│ - Remove: sdl2, sdl2-ttf (raylib bundles its own backend)                                                                                                                                                     │
│ - Keep but stop compiling: pdcurses/ directory (stays in repo, removed from CMake)                                                                                                                            │
│                                                                                                                                                                                                               │
│ ---                                                                                                                                                                                                           │
│ New Files to Create                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ src/Renderer/Renderer.h/.cpp - Core rendering abstraction                                                                                                                                                     │
│                                                                                                                                                                                                               │
│ Replaces all curses drawing. Owns two Texture2D tilesets and a Font. Key methods:                                                                                                                             │
│ - init(int width, int height) / shutdown()                                                                                                                                                                    │
│ - load_tilesets(const char* frame0, const char* frame1)                                                                                                                                                       │
│ - begin_frame() / end_frame() - wraps BeginDrawing/EndDrawing, toggles animation frame every 500ms                                                                                                            │
│ - draw_tile(int grid_y, int grid_x, int cp437_code, int color_pair_id) - replaces attron(COLOR_PAIR(X)); mvaddch(y,x,ch); attroff(...)                                                                        │
│ - draw_text(int px, int py, std::string_view text, int color_pair_id) - replaces mvwprintw                                                                                                                    │
│ - draw_bar(int px, int py, int w, int h, float ratio, Color filled, Color empty) - replaces HP/hunger bar rendering                                                                                           │
│ - get_color_pair(int id) -> ColorPair{fg, bg} - replaces COLOR_PAIR(n) lookup                                                                                                                                 │
│ - metrics() -> ScreenMetrics{tile_w, tile_h, map_cols, map_rows, gui_rows, window_w, window_h}                                                                                                                │
│ - Color pair IDs (1-22) remain the same integer constants from Colors.h                                                                                                                                       │
│                                                                                                                                                                                                               │
│ src/Renderer/InputSystem.h/.cpp - Non-blocking input                                                                                                                                                          │
│                                                                                                                                                                                                               │
│ Replaces getch()/timeout()/KEY_RESIZE. Key methods:                                                                                                                                                           │
│ - poll() - called once per frame, checks GetKeyPressed(), GetCharPressed(), IsMouseButtonPressed(), IsWindowResized()                                                                                         │
│ - get_key() -> GameKey enum (UP, DOWN, LEFT, RIGHT, W, A, S, D, Q, E, Z, C, ENTER, ESCAPE, TAB, PICK, DROP, INVENTORY, etc.)                                                                                  │
│ - get_char_input() -> int (for MenuName text entry)                                                                                                                                                           │
│ - get_mouse_tile() -> Vector2D (pixel pos / tile size)                                                                                                                                                        │
│ - has_player_action() -> bool (true if a game-meaningful key was pressed)                                                                                                                                     │
│                                                                                                                                                                                                               │
│ src/Renderer/Panel.h/.cpp - Replaces WINDOW*                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ Lightweight value type (pixel rect + text helpers). No resource management (no newwin/delwin lifecycle):                                                                                                      │
│ - draw_text(Renderer&, int row, int col, string_view, int color_pair)                                                                                                                                         │
│ - draw_text_reversed(Renderer&, int row, int col, string_view, int color_pair) - replaces A_REVERSE                                                                                                           │
│ - draw_box(Renderer&, Color border) - replaces box(win, 0, 0)                                                                                                                                                 │
│ - fill(Renderer&, Color) - replaces wclear(win)                                                                                                                                                               │
│ - cols() / rows() - text capacity based on pixel size and font metrics                                                                                                                                        │
│                                                                                                                                                                                                               │
│ src/Systems/AnimationState.h/.cpp - Frame-based animation state machine                                                                                                                                       │
│                                                                                                                                                                                                               │
│ Replaces blocking napms() loops in SpellAnimations/TargetingSystem:                                                                                                                                           │
│ - AnimationType enum: NONE, LIGHTNING, EXPLOSION, PROJECTILE, HIT_FLASH                                                                                                                                       │
│ - AnimationState struct: type, start_time, current_frame, total_frames, path, etc.                                                                                                                            │
│ - advance(double delta) -> bool (true when complete)                                                                                                                                                          │
│ - render(Renderer&, GameContext&) - draws current frame                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ ---                                                                                                                                                                                                           │
│ Migration Phases (game compiles and runs at each checkpoint)                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ Phase A: Build System + Stubs                                                                                                                                                                                 │
│                                                                                                                                                                                                               │
│ Files: CMakeLists.txt, vcpkg.json, new Renderer/*.h/.cpp files                                                                                                                                                │
│                                                                                                                                                                                                               │
│ 1. Create src/Renderer/Renderer.h, Renderer.cpp with stub implementations                                                                                                                                     │
│ 2. Create src/Renderer/InputSystem.h, InputSystem.cpp with stubs                                                                                                                                              │
│ 3. Create src/Renderer/Panel.h, Panel.cpp with stubs                                                                                                                                                          │
│ 4. Update vcpkg.json: add raylib, remove sdl2, sdl2-ttf                                                                                                                                                       │
│ 5. Update CMakeLists.txt:                                                                                                                                                                                     │
│   - find_package(raylib CONFIG REQUIRED)                                                                                                                                                                      │
│   - Remove PDCurses source globs (pdcurses/sdl2/*.c, pdcurses/pdcurses/*.c, etc.)                                                                                                                             │
│   - Add new Renderer source files                                                                                                                                                                             │
│   - Remove SDL2/SDL2-ttf find_path/find_library                                                                                                                                                               │
│   - Link raylib instead of PDCurses+SDL2                                                                                                                                                                      │
│   - Update Emscripten section: remove ASYNCIFY, add raylib Emscripten flags                                                                                                                                   │
│ 6. Add Renderer* and InputSystem* to GameContext.h                                                                                                                                                            │
│ 7. Add Renderer and InputSystem members to Game.h, wire into context()                                                                                                                                        │
│                                                                                                                                                                                                               │
│ Checkpoint: Project compiles with raylib. Window opens but nothing renders.                                                                                                                                   │
│                                                                                                                                                                                                               │
│ Phase B: Colors + Controls + Main Loop                                                                                                                                                                        │
│                                                                                                                                                                                                               │
│ Files: Colors.h, Colors.cpp, Controls.h, main.cpp, Game.h                                                                                                                                                     │
│                                                                                                                                                                                                               │
│ 1. Colors.h - keep all 22 inline constexpr pair IDs, remove struct Colors with my_init_pair() (initialization moves to Renderer::init_color_pairs())                                                          │
│ 2. Colors.cpp - gut or delete (all init_pair() calls move to Renderer)                                                                                                                                        │
│ 3. Controls.h - remove #include <curses.h>, replace KEY_UP/KEY_DOWN/KEY_LEFT/KEY_RIGHT/KEY_MOUSE values with GameKey enum usage. The Controls enum maps to GameKey values                                     │
│ 4. main.cpp - complete rewrite:                                                                                                                                                                               │
│   - raylib InitWindow() / SetTargetFPS(60) / SetExitKey(0)                                                                                                                                                    │
│   - Create Renderer, load tilesets/font                                                                                                                                                                       │
│   - Frame-based loop: while (!WindowShouldClose() && game.run) { input.poll(); game.tick_frame(loopNum, input); renderer.begin_frame(); game.render_frame(ctx); renderer.end_frame(); }                       │
│   - #ifdef EMSCRIPTEN wrapper with emscripten_set_main_loop_arg()                                                                                                                                             │
│ 5. Game.h - split tick() into tick_frame() (logic only when player acts) and render_frame() (every frame)                                                                                                     │
│                                                                                                                                                                                                               │
│ Checkpoint: Compiles, raylib window with black screen, frame loop running.                                                                                                                                    │
│                                                                                                                                                                                                               │
│ Phase C: Map + Actor Rendering                                                                                                                                                                                │
│                                                                                                                                                                                                               │
│ Files: Map.h, Map.cpp, Actor.cpp, RenderingManager.h/.cpp, GameLoopCoordinator.cpp                                                                                                                            │
│                                                                                                                                                                                                               │
│ 1. Map.h - remove #include <curses.h>, change get_map_width()/get_map_height() to take ScreenMetrics or use Renderer pointer. Keep COLS/LINES fallback for tests                                              │
│ 2. Map.cpp::render() - replace every attron(COLOR_PAIR(X)); mvaddch(y,x,ch); attroff(...) with ctx.renderer->draw_tile(y, x, ch, X). This is mechanical: same tile types, same CP437 codes, same color pair   │
│ IDs                                                                                                                                                                                                           │
│ 3. Actor.cpp::render() - same pattern: ctx.renderer->draw_tile(position.y, position.x, actorData.ch, actorData.color)                                                                                         │
│ 4. RenderingManager.cpp - remove extern pdc_tileset_active, remove clear()/refresh()/doupdate() calls. safe_screen_clear() becomes ClearBackground(BLACK). force_screen_refresh() becomes no-op (frame-based) │
│ 5. GameLoopCoordinator.cpp - remove extern pdc_tileset_active / PDC_animate_tiles, remove animation tick branch (Renderer handles it), remove pdc_tileset_active = 1/0 toggles in render phase                │
│                                                                                                                                                                                                               │
│ Checkpoint: Map tiles and actors render with DawnLike sprites. Animation works automatically.                                                                                                                 │
│                                                                                                                                                                                                               │
│ Phase D: Input System                                                                                                                                                                                         │
│                                                                                                                                                                                                               │
│ Files: InputHandler.h/.cpp, AiPlayer.cpp/.h, Controls.h                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ 1. InputHandler.h/.cpp - rewrite: remove <curses.h>, key_listen() reads from InputSystem, get_mouse_position() uses raylib GetMousePosition(), remove timeout()/nodelay()/resize_term()                       │
│ 2. AiPlayer.cpp - replace curses key constants (KEY_UP, etc.) with GameKey comparisons. This file has the main key->action mapping switch                                                                     │
│ 3. All input code becomes non-blocking                                                                                                                                                                        │
│                                                                                                                                                                                                               │
│ Checkpoint: Player can move, fight, interact. Basic gameplay works.                                                                                                                                           │
│                                                                                                                                                                                                               │
│ Phase E: GUI Panel                                                                                                                                                                                            │
│                                                                                                                                                                                                               │
│ Files: Gui.h, Gui.cpp                                                                                                                                                                                         │
│                                                                                                                                                                                                               │
│ 1. Remove WINDOW* members (guiWin, statsWindow, messageLogWindow)                                                                                                                                             │
│ 2. Replace with Panel objects                                                                                                                                                                                 │
│ 3. gui_init() creates Panels at bottom of screen                                                                                                                                                              │
│ 4. gui_render() rewritten: HP bar with Panel::draw_bar(), stats/attrs/messages with Panel::draw_text()                                                                                                        │
│ 5. gui_shutdown() becomes trivial (no delwin needed)                                                                                                                                                          │
│ 6. gui_width() / GUI_HEIGHT reference Renderer::metrics() instead of COLS/LINES                                                                                                                               │
│                                                                                                                                                                                                               │
│ Checkpoint: HUD visible with HP, stats, message log.                                                                                                                                                          │
│                                                                                                                                                                                                               │
│ Phase F: Menu System                                                                                                                                                                                          │
│                                                                                                                                                                                                               │
│ Files: BaseMenu.h/.cpp, Menu.h/.cpp, MenuClass.h/.cpp, MenuGender.h/.cpp, MenuRace.h/.cpp, MenuName.h/.cpp, MenuTrade.h/.cpp, MenuBuy.h/.cpp, MenuSell.h/.cpp, MenuSpellCast.h/.cpp                           │
│                                                                                                                                                                                                               │
│ 1. BaseMenu.h/.cpp - remove WINDOW*, replace with Panel. menu_new() creates Panel. menu_key_listen() reads InputSystem. menu_highlight_on/off becomes a draw parameter. Remove                                │
│ newwin/delwin/wbkgd/keypad/wclear/wrefresh                                                                                                                                                                    │
│ 2. Each menu subclass: update draw_content() to use Panel+Renderer. Centering uses renderer.metrics() instead of COLS/LINES. Menus currently block with wgetch() -- they must become per-frame: draw once,    │
│ return, handle input next frame                                                                                                                                                                               │
│ 3. MenuName.cpp - text input via InputSystem::get_char_input()                                                                                                                                                │
│                                                                                                                                                                                                               │
│ Checkpoint: Full character creation flow works.                                                                                                                                                               │
│                                                                                                                                                                                                               │
│ Phase G: UI Screens                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ Files: CharacterSheetUI.h/.cpp, InventoryUI.h/.cpp, LevelUpUI.h/.cpp, DisplayManager.cpp                                                                                                                      │
│                                                                                                                                                                                                               │
│ 1. CharacterSheetUI - replace newwin/box/mvwprintw/wattron/getch/delwin with Panel+Renderer+InputSystem                                                                                                       │
│ 2. InventoryUI - same pattern, 3-tab layout with Panel                                                                                                                                                        │
│ 3. LevelUpUI - same pattern                                                                                                                                                                                   │
│ 4. DisplayManager.cpp - display_help() popup uses Panel                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ These currently block with getch(). Must become state-machine style: render each frame, handle input per-frame, return when dismissed.                                                                        │
│                                                                                                                                                                                                               │
│ Checkpoint: All UI screens functional.                                                                                                                                                                        │
│                                                                                                                                                                                                               │
│ Phase H: Spell Animations + Targeting                                                                                                                                                                         │
│                                                                                                                                                                                                               │
│ Files: SpellAnimations.h/.cpp, TargetingSystem.h/.cpp, SpellSystem.cpp, AnimationState.h/.cpp                                                                                                                 │
│                                                                                                                                                                                                               │
│ 1. Create AnimationState - state machine for lightning/explosion/projectile/hit effects                                                                                                                       │
│ 2. SpellAnimations - animate_lightning(), animate_explosion(), animate_creature_hit() become animation state initializers instead of blocking loops. They set up an AnimationState in GameContext             │
│ 3. RenderingManager::render() checks active animation state and calls animation.render() each frame                                                                                                           │
│ 4. TargetingSystem - select_target()/pick_tile() currently block with getch loop. Must become state machine: GameStatus::TARGETING mode where each frame renders the targeting overlay and processes one      │
│ input                                                                                                                                                                                                         │
│ 5. Add GameStatus::ANIMATING and GameStatus::TARGETING to the enum                                                                                                                                            │
│ 6. GameLoopCoordinator handles these new states                                                                                                                                                               │
│                                                                                                                                                                                                               │
│ Checkpoint: Full combat with animations, ranged targeting, spell casting.                                                                                                                                     │
│                                                                                                                                                                                                               │
│ Phase I: Remaining Curses Cleanup                                                                                                                                                                             │
│                                                                                                                                                                                                               │
│ Files: ~13 scattered files with #include <curses.h> or curses references                                                                                                                                      │
│                                                                                                                                                                                                               │
│ - Teleporter.cpp, Player.cpp, Healer.cpp - remove curses includes, update any render calls                                                                                                                    │
│ - AiMonster.cpp, AiMonsterRanged.cpp, AiShopkeeper.cpp - remove curses includes                                                                                                                               │
│ - ShopKeeper.cpp, MessageSystem.cpp - remove curses includes                                                                                                                                                  │
│ - InventoryOperations.cpp, Container.cpp - remove curses includes                                                                                                                                             │
│ - Remove all extern "C" pdc_* declarations everywhere                                                                                                                                                         │
│ - Remove PDCurses from CMake entirely (stop compiling pdcurses/ sources)                                                                                                                                      │
│                                                                                                                                                                                                               │
│ Checkpoint: Zero curses references in compiled code.                                                                                                                                                          │
│                                                                                                                                                                                                               │
│ Phase J: Emscripten Build                                                                                                                                                                                     │
│                                                                                                                                                                                                               │
│ Files: CMakeLists.txt (Emscripten section), main.cpp                                                                                                                                                          │
│                                                                                                                                                                                                               │
│ 1. raylib has built-in Emscripten support - use emscripten_set_main_loop_arg() wrapper                                                                                                                        │
│ 2. Remove ASYNCIFY flags (no longer needed - input is non-blocking)                                                                                                                                           │
│ 3. Tilesets and font: use --preload-file for raylib resources                                                                                                                                                 │
│ 4. Test web build compiles and runs                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ Checkpoint: Web build works.                                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ Phase K: Tests                                                                                                                                                                                                │
│                                                                                                                                                                                                               │
│ Files: tests/CMakeLists.txt                                                                                                                                                                                   │
│                                                                                                                                                                                                               │
│ 1. Remove PDCurses/SDL2 from test build                                                                                                                                                                       │
│ 2. Tests already run without curses (COLS=0, LINES=0) - use ScreenMetrics defaults (119x22) for fallback                                                                                                      │
│ 3. Tests that don't render should work without InitWindow()                                                                                                                                                   │
│ 4. Verify all 265 tests pass                                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ Checkpoint: All tests pass.                                                                                                                                                                                   │
│                                                                                                                                                                                                               │
│ ---                                                                                                                                                                                                           │
│ Key Architectural Decisions                                                                                                                                                                                   │
│                                                                                                                                                                                                               │
│ 1. Color pair IDs preserved: The 22 integer constants (WHITE_BLACK_PAIR=1, etc.) stay identical. Only the backing store changes from init_pair() to a ColorPair lookup array in Renderer                      │
│ 2. WINDOW -> Panel*: Panels are value types (pixel rect + helpers). No lifecycle management                                                                                                                   │
│ 3. Blocking loops -> state machines: TargetingSystem and SpellAnimations are the hardest conversions. They become states in GameStatus enum                                                                   │
│ 4. pdc_tileset_active eliminated: Map draws sprites via draw_tile(), GUI draws text via draw_text(). No global flag toggle                                                                                    │
│ 5. ASYNCIFY removed: raylib's frame-based loop + emscripten_set_main_loop_arg() is the standard Emscripten pattern                                                                                            │
│ 6. libtcod kept: FOV, pathfinding, BSP generation all remain. Only the rendering layer changes                                                                                                                │
│                                                                                                                                                                                                               │
│ Verification                                                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ 1. Build: cmake --build succeeds with zero warnings for curses                                                                                                                                                │
│ 2. Visual: Map renders DawnLike tiles, animation alternates every 500ms, GUI shows text                                                                                                                       │
│ 3. Gameplay: Full loop: character creation menus -> dungeon -> movement -> combat -> spells -> targeting -> inventory -> level up -> stairs -> victory/defeat                                                 │
│ 4. Web: Emscripten build loads and plays in browser                                                                                                                                                           │
│ 5. Tests: All 265 tests pass                                                                                                                                                                                  │
│ 6. Grep check: rg "curses\.h|pdcurses|initscr|endwin|getch|mvaddch|wrefresh|newwin|delwin" src/ returns zero matches       