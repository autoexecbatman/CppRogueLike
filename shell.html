<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++ RogueLike</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            color: #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            z-index: 10;
        }

        #progress {
            margin-top: 14px;
            width: 240px;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div id="status">Downloading...</div>
        <progress value="0" max="100" id="progress" hidden></progress>
    </div>

    <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>

    <script>
        var statusEl  = document.getElementById('status');
        var progressEl = document.getElementById('progress');
        var overlayEl  = document.getElementById('loading-overlay');

        var Module = {
            preRun:  [],
            postRun: [],

            print: function(text) {
                console.log('STDOUT:', text);
            },

            printErr: function(text) {
                console.error('STDERR:', text);
            },

            canvas: (function() {
                var c = document.getElementById('canvas');
                c.addEventListener('webglcontextlost', function(e) {
                    alert('WebGL context lost. Please reload the page.');
                    e.preventDefault();
                }, false);
                return c;
            })(),

            setStatus: function(text) {
                if (!Module.setStatus.last) {
                    Module.setStatus.last = { time: Date.now(), text: '' };
                }
                if (text === Module.setStatus.last.text) return;

                var m   = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
                var now = Date.now();
                if (m && now - Module.setStatus.last.time < 30) return;

                Module.setStatus.last = { time: now, text: text };

                if (m) {
                    text = m[1];
                    progressEl.value  = parseInt(m[2]) * 100;
                    progressEl.max    = parseInt(m[4]) * 100;
                    progressEl.hidden = false;
                } else {
                    progressEl.hidden = true;
                }

                statusEl.innerHTML = text;

                if (text === '') {
                    overlayEl.style.display = 'none';
                }
            },

            totalDependencies: 0,

            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left
                    ? 'Loading... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')'
                    : 'All downloads complete.');
            }
        };

        Module.setStatus('Downloading...');

        window.onerror = function() {
            Module.setStatus('Exception thrown, see JavaScript console.');
            Module.setStatus = function(t) {
                if (t) console.error('[post-exception] ' + t);
            };
        };
    </script>
    {{{ SCRIPT }}}
</body>
</html>
